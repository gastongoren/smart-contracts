# ðŸš€ Deployment Guide - Railway

## Prerequisites

- GitHub account
- Railway account (https://railway.app)
- Production environment variables ready

---

## Step 1: Prepare the Repository

### 1.1 Commit all changes
```bash
git add .
git commit -m "feat: add database persistence and deployment config"
git push origin main
```

### 1.2 Ensure `.gitignore` excludes sensitive files
```.gitignore
node_modules/
dist/
.env
.env.local
.env.production
```

---

## Step 2: Deploy to Railway

### 2.1 Create Railway Account
1. Go to https://railway.app
2. Sign up with GitHub
3. Authorize Railway to access your repositories

### 2.2 Create New Project
1. Click "New Project"
2. Select "Deploy from GitHub repo"
3. Choose your `smart-contracts` repository
4. Railway will detect Node.js and start building

### 2.3 Add PostgreSQL Database
1. In your Railway project dashboard
2. Click "New" â†’ "Database" â†’ "Add PostgreSQL"
3. Railway automatically creates `DATABASE_URL` variable

---

## Step 3: Configure Environment Variables

In Railway Dashboard â†’ Your Service â†’ Variables tab:

```bash
# App
NODE_ENV=production
PORT=3000
TENANT_DEFAULT_ID=core

# CORS
CORS_ORIGINS=https://your-frontend.com

# Database (auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# AWS S3
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
S3_BUCKET=smart-contracts-prod
S3_PREFIX=uploads/

# Blockchain (Sepolia Testnet recommended for testing)
CHAIN_RPC_URL=https://rpc.ankr.com/eth_sepolia
CHAIN_PRIVATE_KEY=0xyour_private_key
CHAIN_REGISTRY_ADDRESS=0xyour_contract_address

# Firebase
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk@...
```

**Important:** For `FIREBASE_PRIVATE_KEY`, make sure to:
- Keep the quotes
- Replace actual newlines with `\n`

---

## Step 4: Deploy

Railway will automatically:
1. Run `npm install`
2. Run `npm run build` (which includes `prisma generate`)
3. Run database migrations
4. Start the app with `npm run start:prod`

Monitor the deployment in Railway Dashboard â†’ Deployments tab.

---

## Step 5: Verify Deployment

### 5.1 Get your Railway URL
Railway provides a URL like: `https://your-app.up.railway.app`

### 5.2 Test endpoints
```bash
# Health check
curl https://your-app.up.railway.app/health

# Should return: {"status":"ok","timestamp":"..."}
```

---

## Step 6: Custom Domain (Optional)

1. In Railway Dashboard â†’ Settings â†’ Domains
2. Click "Generate Domain" or "Custom Domain"
3. For custom domain:
   - Add CNAME record in your DNS:
     ```
     api.yourdomain.com â†’ your-app.up.railway.app
     ```
   - Wait for DNS propagation (5-30 minutes)

---

## Step 7: Database Migrations

### Initial Migration
Railway runs migrations automatically on deploy via `railway.json`:
```json
{
  "deploy": {
    "startCommand": "npm run prisma:migrate && npm run start:prod"
  }
}
```

### Run migrations manually (if needed)
1. In Railway Dashboard â†’ Your Service
2. Click on the three dots â†’ "Run Command"
3. Enter: `npm run prisma:migrate`

---

## Monitoring & Logs

### View Logs
Railway Dashboard â†’ Deployments â†’ Click on a deployment â†’ View Logs

### Health Monitoring
Railway automatically pings `/health` endpoint every 60 seconds.
If it fails, the service restarts automatically.

---

## Scaling

### Vertical Scaling (More CPU/RAM)
Railway Dashboard â†’ Settings â†’ Resources
- Select plan (Hobby: $5/month, Pro: $20/month)

### Horizontal Scaling
For multiple instances:
- Upgrade to Team plan
- Enable "Replica" feature

---

## Backup Strategy

### Database Backups
Railway provides automatic daily backups for PostgreSQL.

To create manual backup:
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link project
railway link

# Backup database
railway run pg_dump $DATABASE_URL > backup.sql
```

---

## Rollback

If something goes wrong:
1. Railway Dashboard â†’ Deployments
2. Find the last working deployment
3. Click three dots â†’ "Redeploy"

---

## Cost Estimation

| Resource | Free Tier | Hobby | Pro |
|----------|-----------|-------|-----|
| Backend Service | $5 credit | $5/month | $20/month |
| PostgreSQL | Included | Included | Included |
| Total | ~$0-5/month | ~$5-10/month | ~$20+/month |

Free tier includes:
- 500 hours/month execution time
- 100GB outbound bandwidth
- PostgreSQL with 1GB storage

---

## Troubleshooting

### Build fails
- Check logs in Railway Dashboard
- Verify `package.json` scripts are correct
- Ensure `prisma generate` runs in build step

### App crashes on start
- Check environment variables are set correctly
- View logs: Railway Dashboard â†’ Logs
- Verify DATABASE_URL is connected

### Can't connect to database
- Ensure PostgreSQL service is running
- Check DATABASE_URL format
- Run migrations: `railway run npm run prisma:migrate`

### Timeout errors
- Increase `healthcheckTimeout` in `railway.json`
- Check if long-running operations block startup

---

## Alternative: Render.com

If you prefer Render over Railway:

1. Create account at https://render.com
2. New Web Service â†’ Connect GitHub
3. Build Command: `npm install && npm run build`
4. Start Command: `npm run prisma:migrate && npm run start:prod`
5. Add PostgreSQL from Render dashboard
6. Configure environment variables

Render offers:
- Free tier with some limitations
- $7/month for paid tier
- Automatic SSL
- Similar features to Railway

---

## Next Steps

After successful deployment:

1. âœ… Update frontend to use production API URL
2. âœ… Configure CORS to allow your frontend domain
3. âœ… Set up monitoring (optional: Sentry, LogRocket)
4. âœ… Deploy smart contract to testnet/mainnet
5. âœ… Configure real Firebase credentials
6. âœ… Set up real AWS S3 bucket
7. âœ… Add custom domain
8. âœ… Configure CI/CD for auto-deployment

---

## Support

- Railway Docs: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- Prisma Docs: https://www.prisma.io/docs

